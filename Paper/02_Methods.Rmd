---
output:
  pdf_document: default
  html_document: default
---
# 2 Methods

## 2.1 Data Collection and Processing

### 2.1.1 Acoustic detection of beaked whales

The Pacific Missile Range Facility (PMRF) is an instrumented U.S. Naval range extending 70 km NW of the island of Kauai, Hawaii and encompassing 2,800 km^2^.  The range includes a cabled hydrophone array (Fig. 1) with hydrophones at depths ranging from approximately 650 m to 4,700 m. We used data collected before and during six Submarine Command Courses (SCCs) at PMRF. SCCs are training exercises that occur biannually in February and August and typically last 6-7 days.  Acoustic recordings were made for a minimum of two days before each SCC as well as during the exercise.  During data collection, hydrophones sampled at a rate of 96 kHz, with the high pass filter on each hydrophone set at either 50 Hz, 100 Hz, or 10 kHz.  Up to 62 of the range hydrophones were recorded simultaneously by the Naval Information Warfare Center (NIWC).

A beaked whale detector from the Navy Acoustic Range WHale AnaLysis (NARWHAL) algorithm suite [CITE Martin et al. 2020] was run on the recordings.  This detector first compares signal-to-noise (SNR) thresholds within the expected beaked whale click frequency range (16 - 44 kHz) versus the bandwidth outside the click in a running 16,384-pt fast Fourier transform (FFT) spectrogram. The detected clicks were then passed to a 64-pt FFT stage that measured power, bandwidth, slope, and duration characteristics to classify the clicks to species. This process was followed by an automated routine in Matlab (CITE Mathworks 2019) to group detections of individual beaked whale echolocation clicks into GVPs [CITE Henderson et al. 2019]. If a group of whales was detected by more than one hydrophone, the GVP was assigned to the hydrophone that recorded the most clicks. The data were then aggregated to indicate the presence or absence of the start of a GVP for each hydrophone within each half-hour period. 

```{r fig1, fig.cap="Map of approximate locations of hydrophones (black points) at the Pacific Missile Range Facility near the island of Kauai, Hawaii.  Color scale indicates bathymetry. Inset map shows range location relative to the Main Hawaiian Islands.", out.width = '50%', fig.align='center'}
include_graphics("../Figures/Map_Light.png")
```

### 2.1.2 Modelling received levels of hull-mounted mid-frequency active sonar

LIZ SEE Qs IN BRACKETS.  ALSO I REARRANGED SOME SENTENCES SO PLS CHECK.

For security reasons, classified data regarding activity that occurred on the range during each SCC was passed from PMRF to one author with clearance (EEH).  These data indicated the locations of the ships during the training periods and the start and stop times of each individual training event.  However, no information was provided on the start and stop of sonar use; hence, periods of active sonar were determined from the range hydrophone recordings by running a sonar detector from the NARWHAL algorithm suite tuned to MFAS.  The hydrophone recordings cannot be reliably used to determine received level when the received level exceeds XXX dB re. 1 $\mu$ Pa [LIZ Q: HOW DO WE SAY THIS?  I WANT TO EXPLAIN WHY WE DIDN'T USE THE RECORDED LEVELS.].  Therefore, we used propagation modelling to estimate transmission loss and calculate the expected maximum received level of hull-mounted MFAS around the location of each hydrophone.  First, the locations of all surface ships were noted for each half-hour period and the closest ship to each hydrophone was determined.  MFAS propagation was modelled using the parabolic equation propagation model in the program Peregrine (OASIS; Heaney and Campbell, 2016).  Transmission loss was estimated using a 200 Hz band around the center frequency of the sonar (3.5 kHz).  The transmission loss was estimated along the radial from the ship to the hydrophone from a distance of 1 km before the hydrophone to 1 km past the hydrophone in 200 m increments and converted to received levels based on the source level of the sonar.  [LIZ Q: WAS THE SOURCE LEVEL KNOWN OR ASSUMED?  CAN WE SAY WHAT IT WAS?]  The maximum modeled received level along that radial was determined for each hydrophone and half-hour period.  However, if the distance between the ship and the hydrophone was less than the depth of the water column, the parabolic equation would overestimate transmission loss at that angle.  In these cases, a simple sonar equation was used to estimate transmission loss instead.  Transmission loss was estimated at depth since Blainvilleâ€™s beaked whales do not begin clicking until they have reached approximately 200-500 m depth of their foraging dive and spend most of their foraging dive at around 1,000-1,500 m [CITE Johnson et al. 2004, 2006, Madsen et al. 2013].  For hydrophones shallower than 1,000 m the received level was estimated at a point 20 m above the sea floor with a +/- 10 m buffer, while for hydrophones deeper than 1,000 m the received level was estimated at a depth of 1,000 m with a +/- 10 m buffer.  This process resulted in an estimate of received level for each hydrophone and half-hour period.  Uncertainty in the modeled received levels was not considered.

## 2.2 Spatial Modelling

We used a multi-stage generalized additive modelling [GAM; @wood_generalized_2017-1] approach to control for the underlying spatial distribution of Blainville's beaked whales when modelling the effects of training activities and of MFAS.  We first used a tessellation to determine the area effectively monitored by each hydrophone.  Then, we used pre-activity data to create a spatial model of the probability of GVPs across the range prior to the onset of naval activity.  We used the predicted values from this model as an offset in a model created using data from when naval activity was present on the range, but MFAS was not.  We then used the predicted values from this second model as an offset in a third model created using data when naval activity and MFAS were present on the range.  Finally, we used posterior simulation to calculate confidence intervals and quantified the change in the probability of detecting GVPs when Naval activity was present and across received levels of MFAS.

### 2.3.1 Determining hydrophone effort

For security reasons, randomly jittered locations and depths of hydrophones at PMRF were used.  We projected the coordinates of each hydrophone into Universal Transverse Mercator Zone 4.  Because the beaked whale detection algorithm assigned GVPs to the hydrophone that recorded the most echolocation clicks, and because the spatial separation of the hydrophones was not uniform, effort was not the same for all hydrophones.  This means that some hydrophones may have detected more GVPs because they were further away from other hydrophones, not because they were located in higher-density areas.  We account for this by determining the area effectively monitored by each hydrophone.  To do this, we used a Voronoi tessellation implemented in the \textsf{R} [@r_core_team_r_2018-1] package \texttt{deldir} [@turner_deldir_2019] to define a tile for each hydrophone that contained all points on the range that were closest to that hydrophone.  The area of each tile corresponded to the effective area monitored.  We assumed that beaked whale groups occur within the tessellation tile of the hydrophone to which the GVP is assigned.  For hydrophones on the outside of the range, i.e., not surrounded by other hydrophones, we used a cutoff radius of 6,500 m to bound the tessellation tile.  This distance is based on the maximum detection distance of individual Blainville's beaked whale clicks at a U.S. Naval range in the Bahamas [@marques_estimating_2009]. Different combinations of hydrophones were used during different SCCs, so separate tessellations were created for each SCC.

### 2.3.2 M1: Modelling the pre-activity probability of dive detection

We used data collected prior to SCCs, when no naval ships were present on the range and no other naval activity was known to occur, to model the spatial distribution of GVP detections across the range.  Because of the way that GVPs were assigned to hydrophones (see Section 2.1.1) the data were not continuous in space.  To account for this, we used a Markov random field (MRF) to model the spatial distribution of GVP detections. Markov random fields [@rue_gaussian_2005] model correlation in space between discrete spatial units (henceforth, "tiles"). The correlation between two tiles is dictated by distance, as measured by the number of other tiles one needs pass through to travel between two tiles ("hops"); correlation is strongest between a tile and its direct neighbors (those tiles it shares a border with) and decreases with additional hops. This is appropriate for our data as we did not know where in each tile a given GVP occurred, but we assumed that it did occur in that tile.

We modelled the probability of a GVP at tile $i$ as a Bernoulli trial: $\texttt{GVP}_i \sim \text{Bin}(1, \mu_{\texttt{M1},i})$. The linear predictor for the model was modelling on the logit scale:
\begin{equation*}
    \text{logit}\left(\mu_{\texttt{M1},i}\right) = \beta_{\texttt{M1},0} +  f(\texttt{MRF}_i) + f(\texttt{Depth}_i) + \log_e A_i, \qquad (\texttt{M1})
\end{equation*}
where $\beta_{\texttt{M1},0}$ is an intercept, $f(\texttt{MRF}_i)$ denotes the Markov random field used to smooth space, $f(\texttt{Depth}_i)$ is a smooth of depth (using a thin plate spline; @wood_thin_2003) and $\log_e A_i$ is an offset for the area (in $\text{km}^2$) of each tile, $A_i$. The offset term accounts changes in probabilities of GVP detection due to the differing area monitored by each hydrophone. Because the hydrophone tessellation changed between SCCs (as there were different sets of hydrophones recorded during each SSC), separate MRFs were used for each SCC, but a single smoothing parameter was estimated across all MRFs. This allows for different spatial smooths for each SCC, but constrains the smooths to have the same amount of wiggliness. The smooth of depth was shared across SCCs.

### 2.3.3 M2: Modelling the effect of Naval activity

For a few days prior to the onset of hull-mounted MFA sonar used during SCCs, other naval training activities occurred at PMRF.  Various vessels were present on the range during this period and other noise sources, including torpedoes and submarines, may have been present.  We used data collected when training activity was present on the range, but hull-mounted MFAS was not used, to model the effect of general naval activity on beaked whale GVPs.  Initially, we tried to use low-frequency noise levels in the 10-999 Hz range measured on range hydrophones as a covariate in this model, but found that the measured noise levels were not consistent with known locations of naval training activities.

We used the predicted baseline probability of a GVP detection from \texttt{M1} as an offset to control for the underlying spatial distribution of GVPs.  The model for the data when ships were present was intercept-only, with an offset derived from \texttt{M1}. We again modelled GVP presence at tile $i$ as $\texttt{GVP}_i \sim \text{Bin}(1, \mu_{\texttt{M2},i})$, with a linear predictor on the logit scale:
\begin{equation*}
    \text{logit}\left(\mu_{\texttt{M2},i}\right) = \beta_{\texttt{M2},0} + \log_e \xi_{\texttt{M1}, i}, \qquad (\texttt{M2})
\end{equation*}
where $\beta_{\texttt{M2},0}$ is an intercept and $\xi_{\texttt{M1}, i}$ is the prediction (on the $\text{logit}$ scale) for tile $i$ using model $\texttt{M1}$, included as an offset term.

### 2.3.4 M3: Modelling the effect of hull-mounted MFA sonar

We used data collected when hull-mounted MFAS was present on the range to model the effect of sonar on beaked whales. The probability of a GVP when sonar was present was modeled as a function of the maximum received level (modeled at each hydrophone for each half-hour period; see section 2.2). We assumed that as the maximum received level increased, the probability of dives decreased and modeled this using a monotonically decreasing smooth so that the relationship held for all possible realizations of the smooth [@pya_shape_2015]. To ensure that the model predictions were the same at a maximum received level of 0 dB and when ships were not present, we did not include an intercept. GVP presence at tile $i$ was modelled as a Bernoulli trial $\texttt{GVP}_i \sim \text{Bin}(1, \mu_{\texttt{M3},i})$ where the linear predictor on the logit scale was:
\begin{equation*}
    \text{logit}\left(\mu_{\texttt{M3},i}\right) = f(\texttt{MaxRL}_i) + \log_e \xi_{\texttt{M2}, i}, \qquad (\texttt{M3})
\end{equation*}
where $f(\texttt{MaxRL}_i)$ was modeled as a monotonic decreasing smooth, $\xi_{\texttt{M2}, i}$ denotes the prediction (on the $\text{logit}$ scale) for tile $i$ when Naval training activities were present on the range using model $\texttt{M2}$.

### 2.3.5 Uncertainty propagation

We used posterior simulation (sometimes referred to as a parametric bootstrap; @wood_generalized_2017) to propagate uncertainty through M1, M2, and M3. This consisted of sampling from the posterior distribution of the parameters for each model in turn, calculating predictions using these parameters and then refitting the subsequent model with updated offsets. Following this procedure through from M1 to M2 to M3 incorporated uncertainty from each model in the final results.

The prediction grid contained all possible combinations of covariates within the realized covariate space; i.e., each hydrophone for each SCC with associated location, hydrophone depth, and area of the tessellation tile, presence/absence of naval activity, and, if naval activity was present, then either sonar absence or sonar received level between 35 and 190 dB in intervals of 5 dB.

Based on the resulting final posterior distribution of results (for model M3) we can use appropriate quantiles to obtain average predictions and intervals. Mathematical details of the procedure are given in Appendix B.

### 2.3.6 Quantifying the change in probability of GVPs

Finally, we calculated the expected change in $\mathbb{P}(\text{GVP})$ relative to either the distribution of GVPs when no general Naval training activity was present and no MFA sonar was present ($\Delta_{M3':M1'}$), or relative to the distribution of GVPs when general Naval training activity was present but no MFA sonar was present ($\Delta_{M3':M2'}$).

Using the $N_b$ posterior samples from the model, we calculated the expected $\mathbb{P}(\text{GVP})$ under each set of covariates as
\begin{equation}
\mathbb{P}(\text{GVP}) = \text{logit}^{-1} (\mu_{\texttt{M}^\prime} ),
\end{equation}
for each $\texttt{M1}^\prime$, $\texttt{M2}^\prime$, and $\texttt{M3}^\prime$.  Then, we calculated the change in $\mathbb{P}(\text{GVP})$ for each set of covariates $\texttt{M3}^\prime$ and $\texttt{M1}^\prime$ ($\Delta_{M3':M1'}$) and between $\texttt{M3}^\prime$ and $\texttt{M2}^\prime$ ($\Delta_{M3':M2'}$) for each realization of the posterior simulation. 
\begin{align}
\Delta_{M3':M1'} &= \frac{\mathbb{P}(\text{GVP})_{\texttt{M3}^\prime} -  \mathbb{P}(\text{GVP})_{\texttt{M1}^\prime}}{\mathbb{P}(\text{GVP})_{\texttt{M1}^\prime}}\\
\Delta_{M3':M2'} &= \frac{\mathbb{P}(\text{GVP})_{\texttt{M3}^\prime} -  \mathbb{P}(\text{GVP})_{\texttt{M2}^\prime}}{\mathbb{P}(\text{GVP})_{\texttt{M2}^\prime}}
\end{align}
For each received level we calcualted the 2.5th, 50th, and 97.5th quantiles of $\Delta_{M3':M1'}$ and $\Delta_{M3':M2'}$ to create 95\% CIs of change in $\mathbb{P}(\text{GVP})$ across possible received levels.  We consider that the probability of disturbance is equal to 1 wherever the 95\% CI does not include 0, and 0 otherwise.

### 2.3.7 Implementation

NOTE: this section may be moved to an appendix if we have space constraints, but I do prefer to acknowledge the contributions of package developers in the main text if possible.  

Statistical analyses presented in this manuscript were conducted in R [v. 3.5.2; @r_core_team_r_2018-1].  Data import and manipulation was accomplished using tidyverse [@wickham_welcome_2019] packages. \texttt{mgcv} [@wood_generalized_2017-1] and \texttt{scam} [@pya_shape_2015] were used to formulate and fit models. Map creation was facilitated by the \texttt{fields} [@nychka_douglas_fields_2017], \texttt{ggsn} [@santos_baquero_ggsn_2019], \texttt{marmap} [@pante_marmap_2013], \texttt{rgdal} [@bivand_rgdal_2019], \texttt{sf} [@pebesma_simple_2018], and \texttt{sp} [@bivand_applied_2013] packages.  All graphics were produced using \texttt{ggplot2} [@wickham_ggplot2_2016-1], with color palettes from the \texttt{viridis} [@garnier_viridis_2018-1] and \texttt{cmocean} [@thyng_cmocean_2019] packages.  The manuscript was written in \texttt{rmarkdown} [@xie_r_2018]. 

